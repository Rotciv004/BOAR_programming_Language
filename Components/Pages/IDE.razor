@page "/"
@rendermode InteractiveServer
@inject CompilerService Compiler

<h1>Boar IDE</h1>

<div class="row">
	<div class="col-12 col-lg-6 mb-3">
		<label for="editor" class="form-label">Source Code</label>
		<div class="editor-container">
			<div class="editor-gutter" @ref="_gutterRef">
				@for (var i = 1; i <= LineCount; i++)
				{
					<div class="line">@i</div>
				}
			</div>
			<textarea id="editor" class="editor-textarea"
			          @bind="sourceCode"
			          @onscroll="OnScroll"
			          @ref="_editorRef"></textarea>
		</div>
		<div class="mt-2 d-flex gap-2">
			<button class="btn btn-primary" @onclick="HandleParse">Parse</button>
			<button class="btn btn-secondary" @onclick="LoadSample">Load Sample</button>
		</div>
	</div>
	<div class="col-12 col-lg-6">
		@if (output is null)
		{
			<div class="text-muted">Click Parse to see outputs.</div>
		}
		else
		{
			<div class="mb-3">
				<h3 class="h6">PIF (Tokens)</h3>
				<pre class="p-2 border rounded-2 bg-dark text-light" style="max-height: 180px; overflow:auto;">@string.Join("\n", output.PifOutput)</pre>
			</div>
			<div class="mb-3">
				<h3 class="h6">Productions</h3>
				<pre class="p-2 border rounded-2 bg-dark text-light" style="max-height: 220px; overflow:auto;">@string.Join("\n", output.ProductionString)</pre>
			</div>
			@if (output.ParseTree.Count > 0)
			{
				<div class="mb-3">
					<h3 class="h6">Parse Tree (Father-Sibling)</h3>
					<div class="table-responsive border rounded-2" style="max-height: 300px; overflow: auto;">
						<table class="table table-sm table-dark table-striped mb-0">
							<thead>
							<tr>
								<th scope="col">Index</th>
								<th scope="col">Info</th>
								<th scope="col">Parent</th>
								<th scope="col">Right Sibling</th>
							</tr>
							</thead>
							<tbody>
							@foreach (var node in output.ParseTree)
							{
								<tr>
									<td>@node.Index</td>
									<td>@node.Info</td>
									<td>@(node.Parent?.ToString() ?? "-")</td>
									<td>@(node.RightSibling?.ToString() ?? "-")</td>
								</tr>
							}
							</tbody>
						</table>
					</div>
				</div>
			}
			<div class="mb-3">
				<h3 class="h6">Syntax Errors</h3>
				@if (output.Errors.Count == 0)
				{
					<div class="alert alert-success mb-0">Success: No syntax errors!</div>
				}
				else
				{
					<pre class="p-2 border rounded-2 bg-dark text-warning" style="max-height: 180px; overflow:auto;">@string.Join("\n", output.Errors)</pre>
				}
			</div>
		}
	</div>
</div>

@code {
	[Inject] private IJSRuntime JS { get; set; } = default!;

	private string sourceCode = "// Write Boar code here...\n";
	private CompilerOutput? output;
	private ElementReference _editorRef;
	private ElementReference _gutterRef;

	private int LineCount => Math.Max(1, (sourceCode?.Split('\n').Length ?? 1));

	private Task HandleParse()
	{
		output = Compiler.Parse(sourceCode);
		return Task.CompletedTask;
	}

	private async Task OnScroll()
	{
		await JS.InvokeVoidAsync("boarEditor.syncScroll", _gutterRef, _editorRef);
	}

	private Task LoadSample()
	{
		sourceCode = """
		task numa add(numa a, numa b) {
		    numa sum <- a + b;
		    give sum;
		}

		task numa main() {
		    show(add(3, 4));
		    numa x <- 5;
		    numa ref p <- locate(x);
		    at(p) <- 10;
		    show(x);
		    numa ref buf <- claim(4);
		    at(buf) <- 42;
		    show(at(buf));
		    release(buf);
		    vector v <- [1, 2, 3];
		    numa i <- 0;
		    numa s <- 0;
		    repeat (i < 3) {
		        s <- s + v[i];
		        i <- i + 1;
		    }
		    when (s > 5) do {
		        show("big");
		    } other {
		        show("small");
		    }
		    give 0;
		}
		""";
		return Task.CompletedTask;
	}
}

